# ARM64 Support Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:subagent-driven-development to implement this plan task-by-task.

**Goal:** Enable the entire Stardew Valley Dedicated Server project (server, steam-service, xnb-unpacker) to build and run on ARM64 architecture alongside AMD64.

**Architecture:** Multi-stage Docker builds with architecture-aware configuration. Steam-service will include ARM64-compatible OpenSSL. Main Dockerfile will use `$TARGETARCH` build argument for cross-architecture compilation. Makefile and GitHub Actions will support building for both linux/amd64 and linux/arm64 platforms.

**Tech Stack:** Docker buildx, .NET 10, Debian Linux, OpenSSL, GitHub Actions, tmux, jlesage/baseimage-gui

---

## Task 1: Update main Dockerfile for ARM64 support

**Files:**
- Modify: `docker/Dockerfile:1-80` (add build args and update dll-patcher)
- Modify: `docker/Dockerfile:149-152` (update tmux download)

**Step 1: Add TARGETARCH build argument to Dockerfile**

Read the Dockerfile first:

```bash
head -10 docker/Dockerfile
```

Expected output: `FROM mcr.microsoft.com/dotnet/sdk:10.0 AS steam-service-builder`

Replace the beginning of the file:

```dockerfile
# Global build arguments
ARG SMAPI_VERSION=4.1.10
ARG TARGETARCH=amd64
ARG TARGETOS=linux

# ============================================================================
# Stage 1: Build steam-service downloader
# ============================================================================
FROM mcr.microsoft.com/dotnet/sdk:10.0 AS steam-service-builder
```

**Step 2: Update dll-patcher build to use TARGETARCH**

Find and replace line ~76 in the mod-builder stage:

From:
```dockerfile
--runtime linux-x64 \
```

To:
```dockerfile
--runtime linux-$TARGETARCH \
```

Full context (lines 70-79):
```dockerfile
# Build dll-patcher tool
COPY ./tools/dll-patcher /src/dll-patcher
RUN --mount=type=cache,target=/root/.nuget/packages \
    dotnet publish /src/dll-patcher \
    --configuration Release \
    --self-contained true \
    --runtime linux-$TARGETARCH \
    -p:PublishSingleFile=true \
    -p:PublishTrimmed=true \
    -o /output/dll-patcher
```

**Step 3: Update tmux download to detect architecture**

Find and replace lines 149-152 in the server stage:

From:
```dockerfile
# Install tmux (binary download, separate layer for cacheability)
RUN curl -L -O https://github.com/tmux/tmux-builds/releases/download/v3.6a/tmux-3.6a-linux-x86_64.tar.gz && \
    tar -xzf tmux-3.6a-linux-x86_64.tar.gz && \
    install -m 0755 ./tmux /usr/local/bin/tmux && \
    rm -r ./tmux tmux-3.6a-linux-x86_64.tar.gz
```

To:
```dockerfile
# Install tmux (binary download, separate layer for cacheability)
# TARGETARCH is automatically set by docker buildx (amd64, arm64, etc.)
RUN ARCH=$(case ${TARGETARCH} in \
    amd64) echo "x86_64" ;; \
    arm64) echo "aarch64" ;; \
    *) echo "x86_64" ;; \
    esac) && \
    curl -L -O "https://github.com/tmux/tmux-builds/releases/download/v3.6a/tmux-3.6a-linux-${ARCH}.tar.gz" && \
    tar -xzf tmux-3.6a-linux-${ARCH}.tar.gz && \
    install -m 0755 ./tmux /usr/local/bin/tmux && \
    rm -r ./tmux tmux-3.6a-linux-${ARCH}.tar.gz
```

**Step 4: Run the modified Dockerfile to verify no syntax errors**

```bash
cd /Users/sami/project/git/server_hack_arm/.worktrees/feat-arm64-support
docker build -f docker/Dockerfile --target server --build-arg TARGETARCH=amd64 -t sdvd/server:test-amd64 . 2>&1 | tail -20
```

Expected: Build completes without Docker syntax errors.

**Step 5: Commit the changes**

```bash
cd /Users/sami/project/git/server_hack_arm/.worktrees/feat-arm64-support
git add docker/Dockerfile
git commit -m "feat(docker): add ARM64 support to main Dockerfile

- Add TARGETARCH and TARGETOS build arguments
- Update dll-patcher to use $TARGETARCH for cross-compilation
- Update tmux download to detect and use correct binary (x86_64 for amd64, aarch64 for arm64)
- Enables multi-architecture Docker builds"
```

---

## Task 2: Update steam-service Dockerfile for ARM64 support

**Files:**
- Modify: `tools/steam-service/Dockerfile:14-16` (add OpenSSL dependency)
- Modify: `tools/steam-service/SteamService.csproj:9` (add RuntimeIdentifiers)

**Step 1: Update steam-service runtime Dockerfile to include OpenSSL**

Read the file:

```bash
cat tools/steam-service/Dockerfile
```

Replace the runtime stage (FROM mcr.microsoft.com/dotnet/aspnet:10.0 onwards):

From:
```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:10.0
WORKDIR /app

COPY --from=build /app .
```

To:
```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:10.0
WORKDIR /app

# CRITICAL: Install OpenSSL for SteamKit2 ARM64 compatibility
# SteamKit2 depends on native OpenSSL libraries for cryptography
# This ensures ARM64 systems have the correct architecture-specific OpenSSL
RUN apt-get update && apt-get install -y \
    libssl-dev \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

COPY --from=build /app .
```

**Step 2: Add RuntimeIdentifiers to SteamService.csproj**

Read the file:

```bash
cat tools/steam-service/SteamService.csproj
```

Update the PropertyGroup section:

From:
```xml
  <PropertyGroup>
    <TargetFramework>net10.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <RootNamespace>SteamService</RootNamespace>
    <AssemblyName>SteamService</AssemblyName>
  </PropertyGroup>
```

To:
```xml
  <PropertyGroup>
    <TargetFramework>net10.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <RootNamespace>SteamService</RootNamespace>
    <AssemblyName>SteamService</AssemblyName>
    <!-- Support for both amd64 and arm64 architectures -->
    <RuntimeIdentifiers>linux-x64;linux-arm64</RuntimeIdentifiers>
  </PropertyGroup>
```

**Step 3: Verify the changes**

Read the updated files:

```bash
cat tools/steam-service/Dockerfile | grep -A 10 "FROM mcr.microsoft.com/dotnet/aspnet:10.0"
cat tools/steam-service/SteamService.csproj | grep -A 8 "<PropertyGroup>"
```

Expected: Both files show OpenSSL installation and RuntimeIdentifiers present.

**Step 4: Commit the changes**

```bash
git add tools/steam-service/Dockerfile tools/steam-service/SteamService.csproj
git commit -m "feat(steam-service): add ARM64 support

- Install libssl-dev in runtime container for SteamKit2 compatibility
- Add RuntimeIdentifiers (linux-x64;linux-arm64) to project file
- Ensures steam-service works on both amd64 and ARM64 architectures"
```

---

## Task 3: Update Makefile for multi-architecture builds

**Files:**
- Modify: `Makefile:39` (update build command)
- Add: `Makefile:50-70` (new multi-platform build target)

**Step 1: Add configuration variables to Makefile**

Read the current Makefile:

```bash
head -50 Makefile
```

Add these lines after line 20 (after `export IMAGE_VERSION`):

```makefile
# Multi-platform build support
PLATFORMS ?= linux/amd64
PLATFORMS_MULTIARCH ?= linux/amd64,linux/arm64
BUILD_PLATFORM ?= linux/amd64
```

**Step 2: Update the existing build target**

Modify line 39 to make the platform configurable:

From:
```makefile
		--platform=linux/amd64 \
```

To:
```makefile
		--platform=$(BUILD_PLATFORM) \
```

**Step 3: Add new multi-platform build target**

Add after the `build` target (after line 50):

```makefile
# Build for multiple platforms (requires docker buildx)
build-multiplatform:
	@echo Building multi-platform image for: $(PLATFORMS_MULTIARCH)...
	@docker buildx build \
		--platform=$(PLATFORMS_MULTIARCH) \
		--build-arg BUILD_CONFIGURATION=$(BUILD_CONFIGURATION) \
		-t $(IMAGE_NAME):$(IMAGE_VERSION) \
		$(if $(filter-out local,$(IMAGE_VERSION)),-t $(IMAGE_NAME):latest) \
		--secret id=steam_username,env=STEAM_USERNAME \
		--secret id=steam_password,env=STEAM_PASSWORD \
		--secret id=steam_refresh_token,env=STEAM_REFRESH_TOKEN \
		-f $(DOCKERFILE_PATH) \
		--push \
		--progress=plain \
		.
	@echo Multi-platform build complete.
```

**Step 4: Update help text**

Find the `help` target and add documentation for the new targets:

From:
```makefile
# Show help
help:
	@echo Stardew Valley Dedicated Server
	@echo.
	@echo Targets:
	@echo   make install  - Install development dependencies (commitlint, git hooks)
	@echo   make setup    - Run first-time Steam authentication and game download
	@echo   make up       - Build and start server
	@echo   make build    - Build docker image (tag: local)
	@echo   make logs     - View server logs
	@echo   make cli      - Attach to interactive server console (tmux-based)
	@echo   make down     - Stop the server
	@echo   make clean    - Remove containers, volumes and images
	@echo.
	@echo Note: Use GitHub Actions for building and pushing release images
```

To:
```makefile
# Show help
help:
	@echo Stardew Valley Dedicated Server
	@echo.
	@echo Targets:
	@echo   make install           - Install development dependencies (commitlint, git hooks)
	@echo   make setup             - Run first-time Steam authentication and game download
	@echo   make up                - Build and start server
	@echo   make build             - Build docker image for current platform (tag: local)
	@echo   make build-multiplatform - Build for amd64 and arm64 (requires push)
	@echo   make logs              - View server logs
	@echo   make cli               - Attach to interactive server console (tmux-based)
	@echo   make down              - Stop the server
	@echo   make clean             - Remove containers, volumes and images
	@echo.
	@echo Variables:
	@echo   BUILD_PLATFORM=linux/arm64 - Build for specific platform (default: linux/amd64)
	@echo   PLATFORMS_MULTIARCH=linux/amd64,linux/arm64 - Platforms for multi-build
	@echo.
	@echo Note: Use GitHub Actions for building and pushing release images
```

**Step 5: Verify Makefile syntax**

```bash
cd /Users/sami/project/git/server_hack_arm/.worktrees/feat-arm64-support
make help
```

Expected output: Help text includes new build-multiplatform target.

**Step 6: Commit the changes**

```bash
git add Makefile
git commit -m "feat(makefile): add multi-platform build support

- Add BUILD_PLATFORM variable (default: linux/amd64)
- Add PLATFORMS_MULTIARCH variable for multi-architecture builds
- Make --platform argument configurable in build target
- Add new build-multiplatform target for building amd64 and arm64
- Update help text with new targets and variables"
```

---

## Task 4: Update release GitHub Actions workflow

**Files:**
- Modify: `.github/workflows/release.yml:68` (add platforms)

**Step 1: Read the current release workflow**

```bash
cat .github/workflows/release.yml | grep -A 20 "Build and push Docker image"
```

**Step 2: Add platforms to the build-push-action step**

Find the step at line 61 and add `platforms:` parameter:

From:
```yaml
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
```

To:
```yaml
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
```

**Step 3: Update the build summary to document ARM64 support**

Find the "Build summary" step and add ARM64 info:

From:
```yaml
      - name: Build summary
        run: |
          echo "### Production Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.release-please.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
```

To:
```yaml
      - name: Build summary
        run: |
          echo "### Production Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.release-please.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Supported Architectures:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
```

**Step 4: Verify the YAML syntax**

```bash
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/release.yml'))" && echo "Valid YAML" || echo "Invalid YAML"
```

Expected output: `Valid YAML`

**Step 5: Commit the changes**

```bash
git add .github/workflows/release.yml
git commit -m "feat(ci): enable multi-platform builds for production releases

- Add platforms: linux/amd64,linux/arm64 to Docker build-push-action
- Update build summary to document ARM64 support
- Enables automated multi-architecture image builds on release"
```

---

## Task 5: Update preview GitHub Actions workflow

**Files:**
- Modify: `.github/workflows/preview-build.yml` (add platforms around line 70-80)

**Step 1: Read the current preview workflow**

```bash
cat .github/workflows/preview-build.yml | grep -B 5 -A 15 "build-push-action"
```

**Step 2: Add platforms to the build-push-action step**

Find the build-push-action step and add `platforms:`:

From:
```yaml
      - name: Build and push preview
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
```

To:
```yaml
      - name: Build and push preview
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
```

**Step 3: Verify YAML syntax**

```bash
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/preview-build.yml'))" && echo "Valid YAML" || echo "Invalid YAML"
```

Expected output: `Valid YAML`

**Step 4: Commit the changes**

```bash
git add .github/workflows/preview-build.yml
git commit -m "feat(ci): enable multi-platform builds for preview releases

- Add platforms: linux/amd64,linux/arm64 to preview build workflow
- Enables testing ARM64 builds on every commit to master"
```

---

## Task 6: Update release-steam-service GitHub Actions workflow

**Files:**
- Modify: `.github/workflows/release-steam-service.yml` (add platforms around line 70-80)

**Step 1: Read the current steam-service release workflow**

```bash
cat .github/workflows/release-steam-service.yml | grep -B 5 -A 15 "build-push-action"
```

**Step 2: Add platforms to the build-push-action step**

Find the build-push-action step and add `platforms:`:

From:
```yaml
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./tools/steam-service
          file: ./tools/steam-service/Dockerfile
          push: true
```

To:
```yaml
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./tools/steam-service
          file: ./tools/steam-service/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
```

**Step 3: Verify YAML syntax**

```bash
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/release-steam-service.yml'))" && echo "Valid YAML" || echo "Invalid YAML"
```

Expected output: `Valid YAML`

**Step 4: Commit the changes**

```bash
git add .github/workflows/release-steam-service.yml
git commit -m "feat(ci): enable multi-platform builds for steam-service releases

- Add platforms: linux/amd64,linux/arm64 to steam-service build
- Enables ARM64 steam-service builds on release"
```

---

## Task 7: Update preview-build-steam-service GitHub Actions workflow

**Files:**
- Modify: `.github/workflows/preview-build-steam-service.yml` (add platforms)

**Step 1: Read the current preview steam-service workflow**

```bash
cat .github/workflows/preview-build-steam-service.yml | grep -B 5 -A 15 "build-push-action"
```

**Step 2: Add platforms to the build-push-action step**

Find the build-push-action step and add `platforms:`:

```yaml
      - name: Build and push Steam Service preview
        uses: docker/build-push-action@v6
        with:
          context: ./tools/steam-service
          file: ./tools/steam-service/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
```

**Step 3: Verify YAML syntax**

```bash
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/preview-build-steam-service.yml'))" && echo "Valid YAML" || echo "Invalid YAML"
```

Expected output: `Valid YAML`

**Step 4: Commit the changes**

```bash
git add .github/workflows/preview-build-steam-service.yml
git commit -m "feat(ci): enable multi-platform builds for steam-service previews

- Add platforms: linux/amd64,linux/arm64 to preview steam-service build
- Enables testing ARM64 steam-service on every commit"
```

---

## Task 8: Verify all changes and create summary

**Files:**
- Review: All modified files
- Create: `docs/ARM64_SUPPORT.md` (documentation)

**Step 1: Verify all Docker-related changes**

```bash
cd /Users/sami/project/git/server_hack_arm/.worktrees/feat-arm64-support

# Check main Dockerfile has TARGETARCH
grep "ARG TARGETARCH" docker/Dockerfile && echo "✓ Main Dockerfile has TARGETARCH"

# Check steam-service has OpenSSL
grep "libssl-dev" tools/steam-service/Dockerfile && echo "✓ Steam-service has OpenSSL"

# Check Makefile has multi-platform target
grep "build-multiplatform" Makefile && echo "✓ Makefile has multi-platform target"
```

Expected: All three checks pass.

**Step 2: Verify all workflow changes**

```bash
# Check release.yml has platforms
grep "platforms: linux/amd64,linux/arm64" .github/workflows/release.yml && echo "✓ release.yml has platforms"

# Check preview-build.yml has platforms
grep "platforms: linux/amd64,linux/arm64" .github/workflows/preview-build.yml && echo "✓ preview-build.yml has platforms"

# Check steam-service workflows have platforms
grep "platforms: linux/amd64,linux/arm64" .github/workflows/release-steam-service.yml && echo "✓ release-steam-service.yml has platforms"
grep "platforms: linux/amd64,linux/arm64" .github/workflows/preview-build-steam-service.yml && echo "✓ preview-build-steam-service.yml has platforms"
```

Expected: All four checks pass.

**Step 3: Create ARM64 support documentation**

Create `docs/ARM64_SUPPORT.md`:

```markdown
# ARM64 Support

This project now supports building and running on both `linux/amd64` (x86-64) and `linux/arm64` (ARM 64-bit) architectures.

## Building for ARM64

### Local Development

Build for a specific architecture:

\`\`\`bash
# Build for ARM64
make build BUILD_PLATFORM=linux/arm64

# Build for AMD64 (default)
make build BUILD_PLATFORM=linux/amd64
\`\`\`

### Multi-Platform Builds

Build for both architectures and push to registry:

\`\`\`bash
# Requires docker buildx and Docker registry credentials
make build-multiplatform IMAGE_VERSION=1.4.2
\`\`\`

## Architecture Support Matrix

| Component | AMD64 (x86-64) | ARM64 (aarch64) | Notes |
|-----------|---|---|---|
| .NET SDK/Runtime | ✅ | ✅ | Full support |
| Main Server Image | ✅ | ✅ | Uses jlesage/baseimage-gui |
| Steam-Service | ✅ | ✅ | Requires libssl-dev for SteamKit2 |
| XNB-Unpacker | ✅ | ✅ | Uses Debian base image |
| CI/CD Builds | ✅ | ✅ | Automated via GitHub Actions |

## Technical Details

### Main Dockerfile Changes

- Added `ARG TARGETARCH` and `ARG TARGETOS` for cross-architecture builds
- DLL-patcher now builds with `--runtime linux-$TARGETARCH`
- tmux binary download detects architecture and downloads correct binary

### Steam-Service Changes

- Added `libssl-dev` installation for native OpenSSL support (required for SteamKit2)
- Added `RuntimeIdentifiers` to project file for explicit architecture support

### Makefile Changes

- Added `BUILD_PLATFORM` variable (default: linux/amd64)
- Added `build-multiplatform` target for multi-architecture builds
- Existing `build` target now respects `BUILD_PLATFORM` variable

### GitHub Actions Changes

- All Docker build workflows now include `platforms: linux/amd64,linux/arm64`
- Applies to: release, preview, steam-service release, steam-service preview

## Deployment

Docker Hub automatically serves the correct architecture when pulling images:

\`\`\`bash
# Automatically pulls amd64 on x86-64 systems, arm64 on ARM systems
docker pull sdvd/server:latest
docker pull sdvd/steam-service:latest
\`\`\`

## Testing ARM64 Locally

If you have an ARM-based system:

\`\`\`bash
# Run the server
docker compose up -d

# The correct architecture image will be pulled automatically
\`\`\`

If you're on x86-64 and want to test ARM64 (slow, requires QEMU):

\`\`\`bash
# Build for ARM64 (requires docker buildx)
docker buildx build --platform linux/arm64 -t sdvd/server:test-arm64 .
\`\`\`

## Troubleshooting

### Build fails with "architecture not supported"

Check that your Docker setup supports the target architecture:

\`\`\`bash
docker buildx ls
# Should show available platforms
\`\`\`

### Steam-service fails with "libssl not found"

Ensure the Docker image includes `libssl-dev`:

\`\`\`bash
docker inspect sdvd/steam-service:latest | grep -i ssl
\`\`\`

### Multi-platform builds fail

Ensure you have docker buildx configured:

\`\`\`bash
docker buildx create --use
\`\`\`

## Related

- [Dockerfile](../docker/Dockerfile) - Multi-stage build with ARM64 support
- [Makefile](../Makefile) - Build automation with multi-platform support
- [GitHub Actions Workflows](.github/workflows/) - CI/CD with ARM64 builds
```

**Step 4: Commit all final changes**

```bash
git add docs/ARM64_SUPPORT.md
git commit -m "docs: add ARM64 support documentation

- Document building for specific architectures
- Include architecture support matrix
- Provide troubleshooting guide
- Document deployment and testing procedures"
```

**Step 5: View final commit log**

```bash
git log --oneline -8
```

Expected output: Shows all 8 commits related to ARM64 support.

---

## Summary

This plan transforms the Stardew Valley Dedicated Server to be fully ARM64-capable:

1. **Dockerfile (Main)**: Adds architecture detection and cross-compilation support
2. **Dockerfile (Steam-Service)**: Adds native OpenSSL for ARM64 compatibility
3. **Makefile**: Adds configurable platform support and multi-architecture build target
4. **GitHub Actions (4 workflows)**: Enables automated ARM64 builds for all release types
5. **Documentation**: Comprehensive guide for building and deploying on ARM64

**Total Commits**: 8 commits, all focused and atomic

**Testing**: Each step includes verification commands to ensure correctness

**Next Steps**: Use superpowers:subagent-driven-development to execute this plan task-by-task with code review between each task.
